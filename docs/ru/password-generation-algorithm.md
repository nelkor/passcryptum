# Алгоритм генерации пароля

## Читать на других языках

- [Английский](../en/password-generation-algorithm.md)

## Предисловие

Здесь мы рассмотрим алгоритм генерации паролей, используемый в Passcryptum.
Помимо теории, мы сгенерируем пароль для логина "nelkor" в сервисе "github.com"
при введённом мастер-пароле "123456". Для облегчения ручной работы выберем
минимальную длину пароля — 8 символов. Спецсимволы оставим включенными.

## Алгоритм

### Мастер-пароль

Всё начинается тогда, когда мы вводим мастер-пароль. Приложение вычисляет
хеш[^1] SHA-512 из введённого пароля и хранит его в памяти браузера.

[^1]:
    Чтобы узнать, что такое хеш, пожалуйста, прочитайте
    [статью в Википедии](https://ru.wikipedia.org/wiki/Хеш-функция).

Алгоритм вычисления хеша SHA-512 очень сложен и не будет приведён в этой статье.
Прочитать про него можно в Википедии —
[семейство криптографических алгоритмов SHA-2](https://ru.wikipedia.org/wiki/SHA-2).

Существуют сервисы[^2]
для вычисления хеша SHA-512 [онлайн](https://sha512.online).

[^2]:
    Каким бы способом вычисления хеша SHA-512
    мы ни воспользовались, для одного и того же входного значения результат
    будет всегда одинаковым. В этом суть хеширования!

Итак, для нашего эксперимента мы используем мастер-пароль "123456". Его хеш:
`ba3253876aed6bc22d4a6ff53d8406c6ad864195ed144ab5c87621b6c233b548baeae6956df346ec8c17f5ea10f35ee3cbc514797ed7ddd3145464e2a0bab413`.
Хеш представляет собой число в шестнадцатеричной системе счисления. Это значит,
что помимо цифр, это число может содержать буквы из множества `abcdef`[^3].

[^3]:
    Иногда эти буквы пишут строчными (маленькими),
    иногда прописными (заглавными). Для алгоритма генерации пароля Passcryptum
    хеш мастер-пароля обязательно должен быть записан строчными буквами.

### Уникальная строка логина

Мастер-пароль у нас один, а сервисов и логинов может быть сколько угодно.
Таким образом для каждого логина у нас есть уникальная исходная строка, которая
формируется из следующих частей:

- хеш мастер-пароля;
- имя сервиса;
- имя логина;
- номер версии;
- `1`, если мы используем спецсимволы, `0` — если нет;
- длина пароля.

Эти части записываются друг за другом и разделяются символом `/` (slash).

Составим уникальную исходную строку для нашего эксперимента:
`ba3253876aed6bc22d4a6ff53d8406c6ad864195ed144ab5c87621b6c233b548baeae6956df346ec8c17f5ea10f35ee3cbc514797ed7ddd3145464e2a0bab413/github.com/nelkor/1/1/8`[^4].

[^4]:
    В конце строки мы видим `1/1/8`. Сначала идёт номер версии — `1`.
    Затем идёт `1`, потому что мы используем спецсимволы
    (ну и затем `8` — длина пароля). Если бы мы не использовали спецсимволы,
    конец строки был бы такой — `1/0/8`.

### Зёрна

Одно зёрнышко — это число от нуля до 65535. И нам их нужно столько,
сколько мы хотим символов в пароле. Для нашего эксперимента — 8. Первое,
что мы сделаем для получения зёрен —
вычислим хеш SHA-512 из уникальной исходной строки логина:
`ae87ff96d30d17fe67e88ab599c4beba6446d12188c88beeb4ce9ec41f2a74567e76ac231444cd1908d884e4ea883354165383c4682adcab0b9f406a76974e43`.

Далее, берём N раз по 4 символа из строки получившегося хеша, где N —
желаемое количество символов в пароле:
`ae87, ff96, d30d, 17fe, 67e8, 8ab5, 99c4, beba`.

Каждый из этих "кусочков" по четыре символа делим ещё пополам
и меняем эти половинки местами:
`87ae, 96ff, 0dd3, fe17, e867, b58a, c499, babe`.

И наконец, получим зёрна! Для этого каждый из перевёрнутых "кусочков"
переведём из шестнадцатеричной системы счисления в десятичную:
`34734, 38655, 3539, 65047, 59495, 46474, 50329, 47806`.

Эти числа и будут являться нашими зёрнами.

### Набор символов

Passcryptum гарантирует, что в полученных паролях будет встречаться хотя бы одна
цифра, хотя бы одна строчная буква латинского алфавита и хотя бы одна прописная
буква латинского алфавита. Если для сервиса включена галочка
"использовать специальные символы", то также гарантируется наличие в результате
хотя бы одного специального символа.

Достигается это использованием набора символов,
который состоит из четырёх частей:

- `0123456789`;
- `ABCDEFGHIJKLMNOPQRSTUVWXYZ`;
- `abcdefghijklmnopqrstuvwxyz`;
- <code>`!@#$%^&\*()-\_=+{[]};:"|/.,<></code>.

Если специальные символы не включены, то набор символов состоит из трёх частей.
Четвёртая в этом случае просто исчезает. Для нашего эксперимента мы используем
специальные символы.

### Взятие символов

Мы готовы превращать наши зёрна в символы. Первые четыре зёрнышка возьмут
по одному символу из каждой части набора символов. Если специальные символы
не включены, то это будут первые три зёрнышка.

#### Формула взятия символа на примере первого зёрнышка

Мы должны вычислить [остаток от деления](https://ru.wikipedia.org/wiki/Деление_с_остатком)
зёрнышка на размер соответствующей ему части набора символов. Например, первое
зёрнышко — это `34734`, а первая часть набора символов — `0123456789`.
Первая часть набора символов состоит из десяти символов,
то есть её размер — `10`. Остаток от деления `34734` на `10` — `4`
(34730 делится на 10 без остатка, а 4 — остаётся).

Математическая запись — `34734 % 10 = 4`.

Полученный остаток мы используем в качестве индекса для взятия символа из
соответствующего набора. Это значит, что если остаток равен нулю, то мы возьмём
первый символ; если остаток равен единице — второй и так далее.

Наш первый остаток равен четырём[^5]. Это значит, что мы возьмём пятый символ из
части набора `0123456789`. То есть мы возьмём символ `4`.

[^5]:
    Минимальный остаток от деления числа на размер множества равен нулю,
    а максимальный — на один меньше размера множества. Это значит, что каждый
    возможный остаток от деления соответствует своему элементу множества.

#### Второе, третье и четвёртое зёрна

Вторая и третья части набора символов — это буквы латинского алфавита.
В разных регистрах (заглавные и маленькие). Они обе имеют размер `26`.
Выполним для второго и третьего зёрнышка операции, по аналогии с первым:

- `38655 % 26 = 19`;
- `3539 % 26 = 3`.

Двадцатый символ второй части — `T`. Четвёртый символ третьей части — `d`.
Часть специальных символов имеет размер `28`. Преобразуем четвёртое зёрнышко:
`65047 % 28 = 3`. Четвёртый символ четвёртой части — `#`.

Итого, первые четыре зёрнышка были преобразованы в символы `4Td#`.

#### Остальные зёрнышки

Мы получили по одному представителю каждой части набора символов. То есть мы
исполнили гарантию присутствия в пароле хотя бы одной цифры, прописной буквы,
строчной буквы и специального символа.

Остальные зёрнышки мы преобразуем точно таким же образом, но не для отдельных
частей набора символов, а для всего набора символов целиком. Например, десятым
символом целого набора будет `9`, а одиннадцатым — `A`. Размер целого набора
символов со специальными символами — `90`. Без специальных символов — `62`.

Выполним операции для оставшихся зёрнышек нашего эксперимента:

- `59495 % 90 = 5`, — `5`;
- `46474 % 90 = 34`, — `Y`;
- `50329 % 90 = 19`, — `J`;
- `47806 % 90 = 16`, — `G`.

Итого, зёрна были преобразованы в строку `4Td#5YJG`.

#### Перемешивание

Строка `4Td#5YJG` уже выглядит, как неплохой пароль. Но она не является таковым.
И дело даже не в том, что мы выбрали минимальную длину. Дело в том, что первые
четыре символа довольно-таки предсказуемые. При таком подходе мы точно знаем,
что первый символ будет цифрой, второй — прописной буквой, третий — строчной
буквой, а четвёртый — специальным символом. Не хотелось бы предоставлять такую
информацию тому, кто попытается подобрать наш пароль.

Значит, надо эти символы перемешать! Способ перемешивания следующий: сортируем
зёрна по возрастанию, а каждый символ ставим на ту позицию, на которую встало
породившее его зёрнышко. Выполним эту операцию для нашего эксперимента:

- `3539`, — `d`;
- `34734`, — `4`;
- `38655`, — `T`;
- `46474`, — `Y`;
- `47806`, — `G`;
- `50329`, — `J`;
- `59495`, — `5`;
- `65047`, — `#`;

После перемешивания имеем строку `d4TYGJ5#`. Это готовый пароль!

## Вывод

Passcryptum не делает ничего сверхъестественного,
генерация пароля базируется на совершенно простой арифметике. Любой пользователь
может ввести мастер-пароль "123456" и убедиться в том, что сгенерированный
приложением пароль окажется точно таким же, как результат ручных расчётов.

Даже если по какой-то причине приложение вдруг исчезнет, все пароли можно будет
восстановить вручную. Но вручную генерировать пароли слишком долго,
а интерфейс приложения Passcryptum выполнит все нужные операции за долю секунды.
